# 🚀 AccountIA Sprint 2 - Procesamiento de Documentos\n\n**Status**: ✅ **COMPLETADO**  \n**Fecha**: Diciembre 2024  \n**Versión**: v1.0.0-sprint2\n\n## 🎯 Objetivo del Sprint 2\n\nImplementar el sistema completo de **procesamiento de documentos** que permite a los usuarios cargar archivos de información exógena de la DIAN y procesarlos automáticamente para extraer datos fiscales relevantes.\n\n## ✨ Funcionalidades Implementadas\n\n### 🔄 Flujo Completo de Procesamiento\n\n1. **Carga de Archivos** (Drag & Drop)\n   - ✅ Validación de tipos de archivo (.xlsx, .xls)\n   - ✅ Validación de tamaño (máximo 50MB)\n   - ✅ Upload directo a Google Cloud Storage\n   - ✅ URLs firmadas para seguridad\n\n2. **Procesamiento Asíncrono**\n   - ✅ Workers de Celery para procesamiento en background\n   - ✅ Parser especializado para información exógena\n   - ✅ Extracción de ingresos, retenciones y datos fiscales\n   - ✅ Estados de procesamiento en tiempo real\n\n3. **Interfaz de Usuario**\n   - ✅ Wizard paso a paso\n   - ✅ Indicadores de progreso\n   - ✅ Revisión de datos procesados\n   - ✅ Manejo de errores y reintento\n\n4. **API Backend**\n   - ✅ Endpoints REST para gestión de documentos\n   - ✅ Autenticación y autorización\n   - ✅ Serialización de datos\n   - ✅ Logging y monitoreo\n\n## 🛠️ Arquitectura Técnica\n\n### Backend\n```\nbackend/apps/documents/\n├── models.py           # Modelos de documentos\n├── views.py            # API endpoints\n├── urls.py             # Routing\n├── serializers.py      # Serialización de datos\n├── tasks.py            # Tareas de Celery\n├── services/\n│   └── storage_service.py  # Google Cloud Storage\n└── parsers/\n    └── excel_parser.py     # Parser de información exógena\n```\n\n### Frontend\n```\nfrontend/src/\n├── services/\n│   ├── documentService.ts    # API de documentos\n│   └── declarationService.ts # API de declaraciones\n├── components/declarations/\n│   ├── FileUpload.tsx        # Carga de archivos\n│   ├── ProcessingStatus.tsx  # Estado de procesamiento\n│   └── DataReview.tsx        # Revisión de datos\n└── pages/\n    └── DeclarationWizard.tsx # Wizard principal\n```\n\n### Infraestructura\n- **Docker Compose** con servicios de PostgreSQL, Redis, Celery\n- **Google Cloud Storage** para almacenamiento de archivos\n- **Celery + Redis** para procesamiento asíncrono\n- **Scripts npm** reorganizados para desarrollo\n\n## 🚀 Inicio Rápido\n\n### 1. Configuración Inicial\n```bash\n# Setup automático completo\nnpm run setup:sprint2\n\n# O manual:\nnpm install\ncd frontend && npm install && cd ..\ncd backend && pip install -r requirements.txt && cd ..\n```\n\n### 2. Iniciar Servicios\n```bash\n# Todos los servicios a la vez\nnpm run dev\n\n# O individualmente:\nnpm run docker:up      # Base de datos y Redis\nnpm run backend:dev     # API Django\nnpm run frontend:dev    # Interfaz React\nnpm run celery:dev      # Worker de procesamiento\n```\n\n### 3. Verificación\n```bash\n# Verificar que todo esté funcionando\nnpm run verify:sprint2\n\n# Health check de servicios\nnpm run health\n\n# Ver logs\nnpm run logs\n```\n\n## 📋 Comandos Específicos del Sprint 2\n\n### Testing y Desarrollo\n```bash\n# Tests específicos de documentos\nnpm run documents:test\n\n# Verificar integración con GCS\nnpm run gcs:test\n\n# Probar tareas de Celery\nnpm run celery:test-task\n\n# Shell de Django para debugging\nnpm run documents:shell\n```\n\n### Monitoreo\n```bash\n# Logs por servicio\nnpm run logs:backend\nnpm run logs:frontend\nnpm run logs:postgres\nnpm run logs:redis\n\n# Health checks\nnpm run health:backend\nnpm run health:frontend\nnpm run health:celery\n```\n\n### Base de Datos\n```bash\n# Aplicar migraciones\nnpm run db:migrate\n\n# Crear migraciones\nnpm run db:makemigrations\n\n# Shell de PostgreSQL\nnpm run db:shell\n```\n\n## 🧪 Testing\n\n### Casos de Prueba Implementados\n\n1. **Carga de Archivos**\n   - Validación de tipos de archivo\n   - Límites de tamaño\n   - Generación de URLs firmadas\n   - Upload a storage\n\n2. **Procesamiento**\n   - Parser de Excel funcional\n   - Extracción de datos correcta\n   - Manejo de errores\n   - Estados de procesamiento\n\n3. **API Backend**\n   - Autenticación requerida\n   - Endpoints funcionando\n   - Serialización correcta\n   - Manejo de errores\n\n### Ejecutar Tests\n```bash\n# Todos los tests\nnpm run test\n\n# Solo backend\nnpm run test:backend\n\n# Solo documentos\nnpm run documents:test\n\n# Con coverage\nnpm run test:coverage\n```\n\n## 🔧 Configuración\n\n### Variables de Entorno Requeridas\n\n#### `.env` (root)\n```env\n# Firebase (ya configurado)\nVITE_FIREBASE_API_KEY=your_key\nVITE_FIREBASE_AUTH_DOMAIN=your_domain\n# ... resto de configuración Firebase\n```\n\n#### `backend/.env`\n```env\n# Base de datos\nDATABASE_URL=postgresql://accountia_user:accountia_password@localhost:5432/accountia_dev\n\n# Redis/Celery\nREDIS_URL=redis://localhost:6379/0\nCELERY_BROKER_URL=redis://localhost:6379/0\nCELERY_RESULT_BACKEND=redis://localhost:6379/0\n\n# Google Cloud Storage\nGOOGLE_CLOUD_PROJECT=accountia-dev-0001\nGCS_BUCKET_NAME=accountia-dev-documents-0001\nGOOGLE_APPLICATION_CREDENTIALS=config/credentials/google-cloud-credentials.json\n\n# Desarrollo (usa mock storage)\nUSE_MOCK_STORAGE=true\nMOCK_STORAGE_PATH=/app/mock_storage\n```\n\n### Google Cloud Storage (Producción)\n\nPara producción, necesitarás:\n\n1. **Proyecto GCP** configurado\n2. **Bucket de Storage** creado\n3. **Service Account** con permisos\n4. **Credenciales JSON** en `backend/config/credentials/`\n5. Cambiar `USE_MOCK_STORAGE=false`\n\n## 📊 Estados del Sistema\n\n### Estados de Documentos\n- `pending` → Documento creado, esperando subida\n- `uploading` → Archivo siendo subido\n- `uploaded` → Archivo subido exitosamente\n- `processing` → Procesamiento en curso\n- `processed` → Procesamiento completado exitosamente\n- `error` → Error en cualquier etapa\n\n### Flujo de Estados\n```\npending → uploading → uploaded → processing → processed\n    ↓         ↓          ↓           ↓\n  error ←── error ←── error ←── error\n```\n\n## 🌐 Endpoints API\n\n### Documentos\n```\nPOST   /api/v1/declarations/{id}/documents/initiate_upload/\nPUT    /api/v1/documents/{id}/update_status/\nGET    /api/v1/declarations/{id}/documents/\nGET    /api/v1/declarations/{id}/documents/summary/\nGET    /api/v1/documents/{id}/processed_data/\nPOST   /api/v1/documents/{id}/reprocess/\nGET    /api/v1/documents/{id}/download_url/\nDELETE /api/v1/documents/{id}/\n```\n\n### Health Check\n```\nGET    /health/\n```\n\n## 🐛 Resolución de Problemas\n\n### Problemas Comunes\n\n1. **Error de conexión a Redis**\n   ```bash\n   # Verificar que Redis esté corriendo\n   npm run docker:up\n   redis-cli ping\n   ```\n\n2. **Error de migraciones**\n   ```bash\n   # Aplicar migraciones\n   npm run db:migrate\n   ```\n\n3. **Error de permisos en archivos**\n   ```bash\n   # En Linux/Mac\n   chmod +x scripts/*.sh\n   ```\n\n4. **Celery worker no procesa**\n   ```bash\n   # Verificar worker\n   npm run celery:status\n   npm run celery:worker\n   ```\n\n### Logs y Debugging\n```bash\n# Ver logs específicos\nnpm run logs:backend      # Django logs\nnpm run logs:frontend     # Vite logs\nnpm run celery:worker     # Celery logs\n\n# Health check completo\nnpm run health\n\n# Verificación completa\nnpm run verify:sprint2\n```\n\n### Reset Completo\n```bash\n# Si todo falla, reset completo\nnpm run docker:clean\nnpm run clean\nnpm run setup:sprint2\n```\n\n## 📈 Próximos Pasos (Sprint 3)\n\nCon el Sprint 2 completado, el sistema está preparado para:\n\n- 🧠 **Integración de IA** para análisis automático\n- 💡 **Recomendaciones inteligentes** de optimización fiscal\n- 📊 **Dashboards avanzados** con visualizaciones\n- 🔍 **Sistema RAG** con base de conocimiento fiscal\n- 📄 **Generación automática** de borradores\n\n## 🤝 Contribución\n\nPara contribuir al desarrollo:\n\n1. **Fork** del repositorio\n2. **Branch** para tu feature: `git checkout -b feature/nueva-funcionalidad`\n3. **Commit** tus cambios: `git commit -am 'Add nueva funcionalidad'`\n4. **Push** al branch: `git push origin feature/nueva-funcionalidad`\n5. **Pull Request** con descripción detallada\n\n### Estándares de Código\n```bash\n# Antes de commit\nnpm run lint            # Verificar estilo\nnpm run format          # Formatear código\nnpm run test            # Ejecutar tests\n```\n\n## 📞 Soporte\n\n- **Documentación**: `docs/` y archivos README\n- **Problemas conocidos**: `PROBLEMAS_SOLUCIONADOS.md`\n- **Verificación**: `npm run verify:sprint2`\n- **Logs**: `npm run logs`\n\n---\n\n**🎉 ¡Sprint 2 completado exitosamente!**\n\nEl sistema ahora puede procesar información exógena de forma automática, proporcionando la base sólida para las funcionalidades de IA del Sprint 3.